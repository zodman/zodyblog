
var Sortables=new Class({options:{constrain:false,clone:true,opacity:0.7,handle:false,revert:false,onStart:Class.empty,onComplete:Class.empty},initialize:function(lists,options){this.setOptions(options);this.idle=true;this.hovering=false;this.newInsert=false;this.bound={start:[],end:this.end.bind(this),move:this.move.bind(this),reset:this.reset.bind(this)};if(this.options.revert){var revertOptions=$merge({duration:250,wait:false},this.options.revert);this.effect=new Fx.Styles(null,revertOptions).addEvent('onComplete',this.bound.reset,true);}
this.cloneContents=!!(this.options.clone);this.lists=$$($(lists)||lists);this.reinitialize();if(this.options.initialize)this.options.initialize.call(this);},reinitialize:function(){if(this.handles)this.detach();this.handles=[];var elements=[];this.lists.each(function(list){elements.extend(list.getChildren());});this.handles=!this.options.handle?elements:elements.map(function(element){return element.getElement(this.options.handle)||element;}.bind(this));this.handles.each(function(handle,i){this.bound.start[i]=this.start.bindWithEvent(this,elements[i]);},this);this.attach();},attach:function(){this.handles.each(function(handle,i){handle.addEvent('mousedown',this.bound.start[i]);},this);},detach:function(){this.handles.each(function(handle,i){handle.removeEvent('mousedown',this.bound.start[i]);},this);},check:function(el){var coords=el.getCoordinates();return(this.curr.y>coords.top&&this.curr.y<coords.bottom)&&(this.curr.x>coords.left&&this.curr.x<coords.right);},where:function(el){var slices=3;var coords=el.getCoordinates();var vslice=Math.floor((coords.bottom-coords.top)/slices);var hslice=Math.floor((coords.right-coords.left)/slices);var curr=this.curr;if((curr.y>coords.top&&curr.y<(coords.top+vslice))||(curr.x>coords.left&&curr.x<(coords.left+hslice))){return'before';}else if((curr.y<coords.bottom&&curr.y>(coords.bottom-vslice))||(curr.x<coords.right&&curr.x>(coords.right-hslice))){return'after';}
return null;},reposition:function(){},start:function(event,element){if(!this.idle)return;this.idle=false;this.orig={'x':event.page.x,'y':event.page.y};this.styles=element.getStyles('margin-top','margin-left','padding-top','padding-left','border-top-width','border-left-width','opacity');this.margin={'top':this.styles['margin-top'].toInt()+this.styles['border-top-width'].toInt(),'left':this.styles['margin-left'].toInt()+this.styles['border-left-width'].toInt()};this.element=element;this.list=this.element.getParent();this.list.hovering=this.hovering=true;this.list.positioned=this.list.getStyle('position').test(/relative|absolute|fixed/);this.startPosition=this.element.getPosition();this.element.setOnTop();var clone=this.options.clone;switch($type(clone)){case'function':this.clone=clone.call(this,this.element);break;case'boolean':clone=(clone)?{'opacity':0.7}:{'visibility':'hidden'};case'object':this.clone=this.element.clone(this.cloneContents).setStyles(clone);}
this.clone.hide();this.clone.injectAfter(this.element);this.clone.style.height=this.element.offsetHeight+'px';this.clone.style.width=this.element.offsetWidth+'px';this.element.$tmp.origWidth=this.element.style.width;this.element.$tmp.origHeight=this.element.style.height;this.element.style.width=this.element.offsetWidth+'px';this.element.style.height=this.element.offsetHeight+'px';this.movement=0;document.addEvent('mousemove',this.bound.move);document.addEvent('mouseup',this.bound.end);event.stop();event.preventDefault();},move:function(event){event=new Event(event);if(event){event.stop();event.preventDefault();}
if(this.movement>0){if(this.movement==1){this.fireEvent('onStart',this.element);this.element.setStyles({'position':'absolute','opacity':this.options.opacity});this.element.show();this.clone.show();}
this.curr={'x':event.page.x,'y':event.page.y};this.mov={'x':this.curr.x-this.orig.x,'y':this.curr.y-this.orig.y};this.position={'x':this.startPosition.x+(this.curr.x-this.orig.x),'y':this.startPosition.y+(this.curr.y-this.orig.y)}
this.reposition();this.element.setStyles({'top':this.position.y-this.margin.top,'left':this.position.x-this.margin.left});if(!this.options.constrain){var len=this.lists.length;var pivot=null;for(var i=0;i<len;i++){var list=this.lists[i];if(this.check(list)){pivot=list;}else{list.hovering=false;}}
if(pivot){if(pivot&&this.clone.parentNode!=pivot){this.list=pivot;this.list.hovering=true;this.list.positioned=this.list.getStyle('position').test(/relative|absolute|fixed/);}}}
if(this.list.hovering){var len=this.list.childNodes.length;var pivot=null;for(var i=0;i<len;i++){var element=this.list.childNodes[i];if($type(element)=='element'){if(element!=this.element&&element!=this.clone&&this.check(element)){pivot=element;}}}
if(pivot&&pivot!=this.clone){var where=this.where(pivot);if(where){if(where=='after'){var next=pivot.nextSibling;while(next&&$type(next)!='element'){next=next.nextSibling;}
if(next){pivot=next;}else{pivot=null;}}
if(pivot){var next=this.clone.nextSibling;while(next&&$type(next)!='element'){next=next.nextSibling;}
if(next!=pivot){this.list.insertBefore(this.clone,pivot);}}else{this.list.appendChild(this.clone);}}else{if(this.clone.parentNode!=this.list){this.list.appendChild(this.clone);}}}else{if(this.clone.parentNode!=this.list){this.list.appendChild(this.clone);}}}}
this.movement++;},end:function(){this.orig=null;document.removeEvent('mousemove',this.bound.move);document.removeEvent('mouseup',this.bound.end);this.element.show();this.element.style.width=this.element.$tmp['origWidth'];this.element.style.height=this.element.$tmp['origHeight'];this.element.style.zIndex='';this.position=this.clone.getPosition([this.list]);this.reposition();if(!this.effect){this.reset();}else{this.effect.element=this.element;this.effect.start({'top':this.position.y-this.margin.top,'left':this.position.x-this.margin.left,'opacity':this.styles.opacity});}},reset:function(){this.element.setStyles({'position':'static','opacity':this.styles.opacity}).injectBefore(this.clone);this.clone.dump();if(this.movement>0){this.fireEvent('onComplete',this.element);}
this.idle=true;},serialize:function(index,modifier){var map=modifier||function(element,index){return element.getProperty('id');}.bind(this);var serial=this.lists.map(function(list){return list.getChildren().map(map,this);},this);if(this.lists.length==1)index=0;return $chk(index)&&index>=0&&index<this.lists.length?serial[index]:serial;}});Sortables.implement(new Events,new Options);